<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SocialHub</title>
  </head>
  <body>
    <h1>SocialHub</h1>

    <h2>Register</h2>
    <input type="text" id="registerUsername" placeholder="Username" />
    <input type="email" id="registerEmail" placeholder="Email" />
    <input type="password" id="registerPassword" placeholder="Password" />
    <button onclick="register()">Register</button>

    <h2>Login</h2>
    <input type="email" id="loginEmail" placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <button onclick="login()">Login</button>

    <h2>Create Post</h2>
    <input type="text" id="postContent" placeholder="Post content" />
    <button onclick="createPost()">Create Post</button>

    <h2>View My Posts</h2>
    <ul id="myPosts"></ul>

    <script>
      async function register() {
        const username = document.getElementById("registerUsername").value;
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;
        const response = await fetch(
          "https://socialhub-production.up.railway.app/users/register",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username, email, password }),
          }
        );
        if (response.ok) {
          window.alert("Registration successful!");
        } else {
          window.alert("Registration failed. Please try again.");
        }
      }

      async function login() {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        const response = await fetch(
          "https://socialhub-production.up.railway.app/users/login",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, password }),
          }
        );
        const data = await response.json();
        console.log(data);
        if (response.ok) {
          const token = data.token;
          localStorage.setItem("token", token);
          window.alert("Login successful!");
          getMyPosts();
        } else {
          window.alert(
            "Login failed. Please check your credentials and try again."
          );
        }
      }

      async function createPost() {
        const content = document.getElementById("postContent").value;
        const token = localStorage.getItem("token");
        const response = await fetch(
          "https://socialhub-production.up.railway.app/posts",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: token,
            },
            body: JSON.stringify({ content }),
          }
        );
        if (response.ok) {
          window.alert("Post created successfully!");
          getMyPosts();
        } else {
          window.alert("Failed to create post. Please try again.");
        }
      }

      async function getMyPosts() {
        const token = localStorage.getItem("token");
        const response = await fetch(
          "https://socialhub-production.up.railway.app/posts",
          {
            headers: {
              Authorization: token,
            },
          }
        );
        const data = await response.json();
        const myPostsElement = document.getElementById("myPosts");
        myPostsElement.innerHTML = "";
        data.forEach((post) => {
          const li = document.createElement("li");
          li.textContent = post.content;
          myPostsElement.appendChild(li);
        });
        refreshPosts();
      }

      async function likePost(postId) {
        const token = localStorage.getItem("token");
        const response = await fetch(
          `https://socialhub-production.up.railway.app/posts/${postId}/like`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: token,
            },
          }
        );
        if (response.ok) {
          window.alert("Post liked!");
          getMyPosts();
        } else {
          window.alert("Failed to like post. Please try again.");
        }
      }

      async function commentPost(postId) {
        const content = prompt("Enter your comment:");
        if (content !== null && content.trim() !== "") {
          const token = localStorage.getItem("token");
          const response = await fetch(
            `https://socialhub-production.up.railway.app/posts/${postId}/comment`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: token,
              },
              body: JSON.stringify({ content }),
            }
          );
          if (response.ok) {
            window.alert("Comment added!");
            getMyPosts();
          } else {
            window.alert("Failed to add comment. Please try again.");
          }
        }
      }

      async function renderPosts(posts) {
        const myPostsElement = document.getElementById("myPosts");
        myPostsElement.innerHTML = "";
        posts.forEach((post) => {
          const li = document.createElement("li");
          li.textContent = post.content;

          // Like button
          const likeButton = document.createElement("button");
          likeButton.textContent = "Like";
          likeButton.onclick = () => likePost(post._id);
          li.appendChild(likeButton);

          // Comment section
          const commentInput = document.createElement("input");
          commentInput.type = "text";
          commentInput.placeholder = "Add a comment";
          const commentButton = document.createElement("button");
          commentButton.textContent = "Comment";
          commentButton.onclick = () => commentPost(post._id);
          li.appendChild(commentInput);
          li.appendChild(commentButton);

          myPostsElement.appendChild(li);
        });
      }

      async function refreshPosts() {
        const token = localStorage.getItem("token");
        const response = await fetch(
          "https://socialhub-production.up.railway.app/posts",
          {
            headers: {
              Authorization: token,
            },
          }
        );
        if (response.ok) {
          const posts = await response.json();
          renderPosts(posts);
        } else {
          window.alert("Failed to fetch posts. Please try again.");
        }
      }
    </script>
  </body>
</html>
